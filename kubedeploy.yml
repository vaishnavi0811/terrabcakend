parameters:
  - name: namespace
  - name: k8sconn
  - name: imageSecret
  - name: registry
  - name: env

resources:
  repositories:
  - repository: k8syaml
    type: git
    endpoint: MyAzureReposGitServiceConnection
    name: backend

steps:
  - checkout: self
  - bash: echo "##vso[task.setvariable variable=secret;isOutput=true]${{ parameters.imageSecret }}"
  - bash: echo "##vso[task.setvariable variable=imagetag;isOutput=true]$(Build.BuildId)"
  - bash: echo "##vso[task.setvariable variable=registry;isOutput=true]${{ parameters.registry }}"
  - bash: echo "##vso[task.setvariable variable=env;isOutput=true]${{ parameters.env }}"
  - task: Kubernetes@1
    displayName: 'create namespace'
    inputs:
      kubernetesServiceEndpoint: '${{ parameters.k8sconn }}'
      command: create
      arguments: 'namespace ${{ parameters.namespace }}'
  - task: qetza.replacetokens.replacetokens-task.replacetokens@3
    displayName: 'Replace tokens in deployment yml'
    inputs:
      targetFiles: '**/*.yml'
      keepToken: true
      tokenPrefix: '${'
      tokenSuffix: '}'
  - task: KubernetesManifest@0
    displayName: deploy
    inputs:
      kubernetesServiceConnection: '${{ parameters.k8sconn }}'
      namespace: '${{ parameters.namespace }}'
      manifests: deployterra.yml
      rolloutStatusTimeout: 10