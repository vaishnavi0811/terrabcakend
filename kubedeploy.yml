parameters:
  - name: k8sconn
  - name: createnamespace
  - name: env
  - name: imagetag
  - name: registry
  - name: token

steps:
  - checkout: self
  - task: Kubernetes@1
    condition: eq('${{ parameters.createnamespace }}', true)
    displayName: 'create namespace'
    inputs:
      kubernetesServiceEndpoint: '${{ parameters.k8sconn }}'
      command: create
      arguments: 'namespace terra${{ parameters.env }}'
  - task: Kubernetes@1
    condition: eq('${{ parameters.createnamespace }}', true)
    displayName: 'create secret'
    inputs:
      kubernetesServiceEndpoint: '${{ parameters.k8sconn }}'
      command: create
      arguments: 'secret terra${{ parameters.env }} -n terra${{ parameters.env }} generic secrets-store-creds --from-literal terraformtoken=${{ parameters.token }}'
  - task: PowerShell@2
    displayName: 'convert params to vars'
    inputs:
      targetType: filePath
      filePath: ./convertvars.ps1
      arguments: '-env ${{ parameters.env }} -imagetag ${{ parameters.imagetag }} -registry ${{ parameters.registry }}'
  - task: qetza.replacetokens.replacetokens-task.replacetokens@3
    displayName: 'Replace tokens in deployment yml'
    inputs:
      targetFiles: '**/deployterra.yml'
      keepToken: true
      tokenPrefix: '${'
      tokenSuffix: '}'
      variableFiles: '**/variables.json'
  - task: KubernetesManifest@0
    displayName: deploy
    inputs:
      kubernetesServiceConnection: '${{ parameters.k8sconn }}'
      namespace: 'terra${{ parameters.env }}'
      manifests: deployterra.yml
      rolloutStatusTimeout: 60